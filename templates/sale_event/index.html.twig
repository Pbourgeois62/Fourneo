{# templates/sale_event/index.html.twig #}
{% extends 'base.html.twig' %}

{% block title %}Liste des événements de vente
{% endblock %}

{% block body %}
	<h1 class="text-title">Événements de vente</h1>
	<div
		class="main-container">

		{# Flowbite Tabs Component #}
		<div class="mb-4 border-b border-golden bg-floor text-coffee flex justify-between items-center">
			<ul class="flex flex-wrap -mb-px text-sm font-medium text-center" id="default-tab" data-tabs-toggle="#sale-event-tabs-content" role="tablist">

				<li class="me-2" role="presentation">
					<button class="inline-block p-4 rounded-t-lg border-b-2 text-coffee bg-cream hover:text-coffee/80 hover:border-golden" id="today-tab" data-tabs-target="#today-events" type="button" role="tab" aria-controls="today-events" aria-selected="false">
						Événements du jour ({{ eventsOfTheDay|length }})
					</button>
				</li>

				<li class="me-2" role="presentation">
					<button class="inline-block p-4 rounded-t-lg border-b-2 text-coffee bg-cream hover:text-coffee/80 hover:border-golden" id="upcoming-tab" data-tabs-target="#upcoming-events" type="button" role="tab" aria-controls="upcoming-events" aria-selected="true">
						Événements à venir ({{ incomingEvents|length }})
					</button>
				</li>

				<li class="me-2" role="presentation">
					<button class="inline-block p-4 rounded-t-lg border-b-2 text-coffee bg-cream hover:text-coffee/80 hover:border-golden" id="closed-tab" data-tabs-target="#closed-events" type="button" role="tab" aria-controls="closed-events" aria-selected="false">
						Événements terminés ({{ closedEvents|length }})
					</button>
				</li>
			</ul>

			<a href="{{ path('sale_event_new') }}" class="btn-validation">
				<i class="bi bi-plus-circle mr-2"></i>Créer un événement
			</a>
		</div>


		<div
			id="sale-event-tabs-content" class="bg-cream p-4 rounded-sm">
			{# Contenu pour les Événements du jour #}
			<div class="hidden p-4 rounded-lg bg- " id="today-events" role="tabpanel" aria-labelledby="today-tab">
				{% if eventsOfTheDay is not empty %}
					<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
						{% for event in eventsOfTheDay %}
							<div class="item-card">
								<h2 class="text-coffee xl font-semibold mb-2">{{ event.name }}</h2>

								{% if event.description %}
									<p class="text-coffee sm italic mb-2">{{ event.description }}</p>
								{% endif %}

								<p class="text-coffee sm text-coffee mb-1">
									<strong>Adresse :</strong>
									{{ event.address }}</p>

								<p class="text-coffee sm mb-1">
									<strong>Début :</strong>
									{{ event.startDate ? event.startDate|date('d/m/Y H:i') : 'Non défini' }}</p>
								<p class="text-coffee sm mb-4">
									<strong>Fin :</strong>
									{{ event.endDate ? event.endDate|date('d/m/Y H:i') : 'Non défini' }}</p>
								<div>
									{% if event.productEvents is not empty %}
										<div class="mt-4 pt-4 border-t border-">
											<h3 class="text-coffee md font-semibold mb-2">Produits mis en vente</h3>
											<ul class="list-disc list-inside text-coffee sm ">
												{% for productEvent in event.productEvents %}
													<li>
														{{ productEvent.product.name }}
														- Quantité:
														{{ productEvent.quantity }}
													</li>
												{% endfor %}
											</ul>
										</div>
									{% else %}
										<p class="text-coffee sm text-coffee 0 mt-4 pt-4 border-t border-">Aucun produit associé à cet événement.</p>
									{% endif %}

									<div class="mt-4 pt-4 border-t border- flex justify-end">
										<a href="{{ path('sale_event_show', {id: event.id}) }}" class="px-4 py-2 bg-blue-600 text-coffee cream rounded-md hover:bg-blue-700 transition">Gérer la vente</a>
									</div>
								</div>

								<div class="absolute top-2 right-2 flex gap-2">
									<a href="{{ path('sale_event_edit', {id: event.id}) }}" class="text-coffee blue-600 hover:text-coffee blue-800" title="Modifier">
										<i class="bi bi-pencil-square text-coffee lg"></i>
									</a>
									<form method="post" action="{{ path('sale_event_delete', {id: event.id}) }}" onsubmit="return confirm('Confirmer la suppression ?');">
										<input type="hidden" name="_method" value="DELETE">
										<input type="hidden" name="_token" value="{{ csrf_token('delete_sale_event_' ~ event.id) }}">
										<button type="submit" class="text-coffee red-600 hover:text-coffee red-800" title="Supprimer">
											<i class="bi bi-trash text-coffee lg"></i>
										</button>
									</form>
								</div>
							</div>
						{% endfor %}
					</div>
				{% else %}
					<p class="item-card ">Aucun événement prévu pour aujourd'hui.</p>
				{% endif %}
			</div>

			{# Contenu pour les Événements à venir (Incoming) #}
			<div class="hidden p-4 rounded-lg bg- " id="upcoming-events" role="tabpanel" aria-labelledby="upcoming-tab">
				{% if incomingEvents is not empty %}
					<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
						{% for event in incomingEvents %}
							<div class="item-card">
								<h2 class="text-coffee xl font-semibold  mb-2">{{ event.name }}</h2>

								{% if event.description %}
									<p class="text-coffee sm text-coffee  italic mb-2">{{ event.description }}</p>
								{% endif %}

								<p class="text-coffee sm  mb-1">
									<strong>Adresse :</strong>
									{{ event.address }}</p>

								<p class="text-coffee sm  mb-1">
									<strong>Début :</strong>
									{{ event.startDate ? event.startDate|date('d/m/Y H:i') : 'Non défini' }}</p>
								<p class="text-coffee sm  mb-4">
									<strong>Fin :</strong>
									{{ event.endDate ? event.endDate|date('d/m/Y H:i') : 'Non défini' }}</p>

								{% if event.productEvents is not empty %}
									<div class="mt-4 pt-4 border-t border-">
										<h3 class="text-coffee md font-semibold  mb-2">Produits mis en vente</h3>
										<ul class="list-disc list-inside text-coffee sm ">
											{% for productEvent in event.productEvents %}
												<li>
													{{ productEvent.product.name }}
													- Quantité:
													{{ productEvent.quantity }}
												</li>
											{% endfor %}
										</ul>
									</div>
								{% else %}
									<p class="text-coffee sm text-coffee 0 mt-4 pt-4 border-t border-">Aucun produit associé à cet événement.</p>
								{% endif %}

								<div class="absolute top-2 right-2 flex gap-2">
									<a href="{{ path('sale_event_edit', {id: event.id}) }}" class="text-coffee blue-600 hover:text-coffee blue-800" title="Modifier">
										<i class="bi bi-pencil-square text-coffee lg"></i>
									</a>
									<form method="post" action="{{ path('sale_event_delete', {id: event.id}) }}" onsubmit="return confirm('Confirmer la suppression ?');">
										<input type="hidden" name="_method" value="DELETE">
										<input type="hidden" name="_token" value="{{ csrf_token('delete_sale_event_' ~ event.id) }}">
										<button type="submit" class="text-coffee red-600 hover:text-coffee red-800" title="Supprimer">
											<i class="bi bi-trash text-coffee lg"></i>
										</button>
									</form>
								</div>
							</div>
						{% endfor %}
					</div>
				{% else %}
					<p class="item-card ">Aucun événement à venir.</p>
				{% endif %}
			</div>

			<div class="hidden p-4 rounded-lg bg- " id="closed-events" role="tabpanel" aria-labelledby="closed-tab">
				{% if closedEvents is not empty %}
					<div class="grid gap-6 md:grid-cols-2 lg:grid-cols-3">
						{% for event in closedEvents %}
							<div class="item-card">
								<h2 class="text-coffee xl font-semibold  mb-2">{{ event.name }}</h2>

								{% if event.description %}
									<p class="text-coffee sm text-coffee  italic mb-2">{{ event.description }}</p>
								{% endif %}

								<p class="text-coffee sm  mb-1">
									<strong>Adresse :</strong>
									{{ event.address }}</p>

								<p class="text-coffee sm  mb-1">
									<strong>Début :</strong>
									{{ event.startDate ? event.startDate|date('d/m/Y H:i') : 'Non défini' }}</p>
								<p class="text-coffee sm  mb-4">
									<strong>Fin :</strong>
									{{ event.endDate ? event.endDate|date('d/m/Y H:i') : 'Non défini' }}</p>

								{% if event.totalProductEventCount > 0 %}
									<div class="mt-4 pt-4 border-t border-">
										<h3 class="text-coffee md font-semibold  mb-2">Bilan des produits :</h3>
										<ul class="text-coffee sm  space-y-1">
											<li>
												<i class="bi bi-box-seam mr-2 text-coffee "></i>
												Total produits en vente :
												<strong class="">{{ event.totalProductEventCount }}</strong>
											</li>
											<li>
												<i class="bi bi-tag-fill mr-2 {% if event.outOfStockProductEventCount > 0 %}text-coffee red-600{% else %}text-coffee green-600{% endif %}"></i>
												Produits en rupture :
												<strong class="{% if event.outOfStockProductEventCount > 0 %}text-coffee red-700{% else %}text-coffee green-700{% endif %}">{{ event.outOfStockProductEventCount }}</strong>
												({{ event.outOfStockPercentage|number_format(0) }}%)
											</li>
											<li>
												<i class="bi bi-archive-fill mr-2 {% if event.totalUnsoldQuantity > 0 %}text-coffee yellow-600{% else %}text-coffee green-600{% endif %}"></i>
												Quantité invendue :
												<strong class="{% if event.totalUnsoldQuantity > 0 %}text-coffee yellow-700{% else %}text-coffee green-700{% endif %}">{{ event.totalUnsoldQuantity }}</strong>
												({{ event.unsoldPercentage|number_format(0) }}%)
											</li>
										</ul>
									</div>
								{% else %}
									<p class="text-coffee sm text-coffee 0 mt-4 pt-4 border-t border-">Aucun produit associé à cet événement.</p>
								{% endif %}

								<div class="mt-4 pt-4 border-t border- flex justify-end">
									<a href="{{ path('sale_event_show', {id: event.id}) }}" class="px-4 py-2 bg- text-coffee cream rounded-md hover:bg-0 transition">Voir le bilan</a>
								</div>
							</div>
						{% endfor %}
					</div>
				{% else %}
					<p class="text-coffee ">Aucun événement terminé.</p>
				{% endif %}
			</div>
		</div>
	</div>
{% endblock %}
